# 月次目標機能 - 機能要件書

**文書番号**: FRD-MG-001
**バージョン**: 2.0.0
**作成日**: 2025-09-13
**作成者**: Development Team
**ステータス**: Draft

## 改訂履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|----------|
| 1.0.0 | 2025-09-13 | Team | 初版作成 |
| 2.0.0 | 2025-09-13 | Team | 日次達成ベース・リワード機能追加 |

## 1. 機能概要

### 1.1 目的
- 1日の中で1回以上ワークアウトを実施すると、その日を「1回」としてカウント（日次達成）
- ユーザーが目標回数とご褒美（リワード）を設定できる仕組みを提供
- 達成状況を可視化し、運動習慣の形成を支援する

### 1.2 スコープ
- **対象**: 登録済みユーザー
- **期間**: MVPでは月次（当月）、将来的にカスタム期間対応
- **カウント方式**: 日次達成（1日1回カウント）
- **機能**: 目標設定、進捗表示、リワード管理

### 1.3 ビジネス価値
- 日次達成による継続的な習慣化促進
- リワードによるゲーミフィケーション
- 目標達成によるモチベーション向上
- ユーザーエンゲージメントの向上

## 2. ユーザーストーリー

### US-001: 月次目標の設定
**As a** ユーザー
**I want to** ワークアウトの目標回数とご褒美を設定したい
**So that** 達成へのモチベーションを維持できる

**受け入れ条件**:
- [ ] 目標回数（targetCount）を1以上の整数で設定できる
- [ ] リワードタイトル（任意）を設定できる
- [ ] リワードのメモ（任意）を記入できる
- [ ] 期間タイプ（月次/カスタム）を選択できる
- [ ] 同一期間に複数のアクティブな目標は作成できない

### US-002: 進捗の確認
**As a** ユーザー
**I want to** 目標に対する進捗を確認したい
**So that** 現在の達成状況を把握できる

**受け入れ条件**:
- [ ] 現在のアクティブな目標と進捗を確認できる
- [ ] 「ワークアウト15回 2/15 【コーヒーミル購入】」形式で表示
- [ ] 進捗バーで視覚的に確認できる
- [ ] 日次達成ベースでカウントされる（同日複数ワークアウトは1回）

### US-003: リワードの受け取り
**As a** ユーザー
**I want to** 目標達成後にご褒美を受け取った状態にしたい
**So that** 達成感を得られる

**受け入れ条件**:
- [ ] 目標達成後にリワードをclaim（受け取り済み）にできる
- [ ] claim日時が記録される
- [ ] 未達成時はclaimできない

### US-004: 目標の管理
**As a** ユーザー
**I want to** 目標を編集・アーカイブしたい
**So that** 状況に応じて調整できる

**受け入れ条件**:
- [ ] タイトル、目標回数、リワード情報を編集できる
- [ ] 目標を非アクティブ化（アーカイブ）できる
- [ ] 自分の目標のみ操作できる

## 3. 機能要件詳細

### 3.1 データ要件

#### 3.1.1 目標エンティティ（goals）
| フィールド | 型 | 必須 | 説明 | 制約 |
|-----------|-----|------|------|------|
| id | INTEGER | ✓ | 主キー | AUTO_INCREMENT |
| userId | INTEGER | ✓ | ユーザーID | FK: users.id |
| title | STRING | × | 目標タイトル | デフォルト: ワークアウト{targetCount}回 |
| targetCount | INTEGER | ✓ | 目標回数 | 1以上 |
| periodType | ENUM | ✓ | 期間タイプ | 'monthly' \| 'custom' |
| startDate | TIMESTAMP | ✓ | 開始日時 | タイムゾーン付き |
| endDate | TIMESTAMP | ✓ | 終了日時 | タイムゾーン付き |
| rewardTitle | STRING | × | リワードタイトル | 例: コーヒーミル購入 |
| rewardNote | TEXT | × | リワードメモ | - |
| rewardClaimed | BOOLEAN | ✓ | リワード受取済み | デフォルト: false |
| rewardClaimedAt | TIMESTAMP | × | リワード受取日時 | nullable |
| isActive | BOOLEAN | ✓ | アクティブ状態 | デフォルト: true |
| createdAt | TIMESTAMP | ✓ | 作成日時 | - |
| updatedAt | TIMESTAMP | ✓ | 更新日時 | - |

#### 3.1.2 制約条件
- 同一ユーザー + 期間重複で isActive=true が複数存在しないこと
- インデックス: (userId, startDate, endDate)

### 3.2 ビジネスルール

#### BR-001: 日次達成カウント
- 1日の中で1回以上ワークアウトを実施 = 1回としてカウント
- 同一日内の複数ワークアウトは1回として集計
- タイムゾーンはJST（Asia/Tokyo）を基準（将来的にユーザー設定対応）

#### BR-002: 期間設定
- periodType='monthly' の場合、start/endを当月に自動補完
- カスタム期間も設計に含めるが、MVPではUIは月次のみ

#### BR-003: リワード管理
- 目標達成（count >= targetCount）でリワードclaim可能
- 未達成時のclaim試行は422エラー

#### BR-004: アクセス制御
- ユーザーは自分の目標のみ操作可能
- JWT認証が必須

### 3.3 進捗計算ロジック

#### 3.3.1 日次達成カウントSQL
```sql
SELECT COUNT(DISTINCT DATE_TRUNC('day', started_at AT TIME ZONE 'Asia/Tokyo'))
FROM workouts
WHERE user_id = :userId
  AND started_at BETWEEN :startDate AND :endDate
  AND status = 'completed'  -- statusカラムがある場合
```

#### 3.3.2 計算仕様
- タイムゾーン境界を考慮（23:30 JST と 00:30 JST の判定）
- 未来日はカウントしない
- Strava同期分も集計対象

#### 3.3.3 表示フォーマット
```
ワークアウト{targetCount}回 {count}/{targetCount} 【{rewardTitle}】
例: ワークアウト15回 2/15 【コーヒーミル購入】
```

## 4. 非機能要件

### 4.1 パフォーマンス
- API応答時間: 95%tile < 500ms
- 同時アクセス: 100ユーザー/秒

### 4.2 セキュリティ
- JWT認証によるアクセス制御
- SQLインジェクション対策
- 入力値検証

### 4.3 可用性
- 99.9% アップタイム
- エラー時の適切なフォールバック

### 4.4 拡張性
- 将来的な目標項目追加に対応可能な設計

## 5. 制約事項

### 5.1 技術制約
- Node.js + Express.js使用
- PostgreSQL + Sequelize ORM使用
- JWT認証機構の利用

### 5.2 ビジネス制約
- MVPとして最小限の機能に限定
- 1週間での実装完了

## 6. 前提条件
- ユーザー認証システムが実装済み
- Workoutデータモデルが存在
- JWT認証ミドルウェアが利用可能

## 7. リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 大量データによるパフォーマンス低下 | 高 | 中 | インデックス最適化、キャッシュ検討 |
| 不正なデータ入力 | 中 | 低 | 厳密なバリデーション実装 |
| 同時更新による競合 | 低 | 低 | 楽観的ロック実装 |

## 8. 成功指標
- 機能リリース後1ヶ月で50%のアクティブユーザーが目標設定
- 目標設定ユーザーの継続率が20%向上
- APIエラー率 < 0.1%