# タスク: 最近のワークアウト表示順序バグ修正

**入力**: `/specs/002-recentworkoutsaccordin/` の設計ドキュメント
**前提条件**: plan.md, spec.md, research.md, data-model.md
**ブランチ**: `002-recentworkoutsaccordin`

**テスト**: 含む - research.mdで詳細なテストケースを伴うテスト戦略が明示的に定義されています

**構成**: タスクはユーザーストーリーごとにグループ化され、各ストーリーの独立した実装とテストが可能です。

## 形式: `[ID] [P?] [Story] 説明`
- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **[Story]**: このタスクが属するユーザーストーリー（US1, US2）
- 説明に正確なファイルパスを含む

## パス規則
これはWebアプリケーションで、`frontend/` と `backend/` ディレクトリがあります。このバグ修正ではフロントエンドのみを変更します。

---

## フェーズ 1: セットアップ (テストインフラ)

**目的**: バグ修正のためのテストファイル構造を作成

- [ ] T001 [P] テストディレクトリ構造 `frontend/tests/unit/` が存在しない場合は作成
- [ ] T002 [P] テストディレクトリ構造 `frontend/src/test/components/Dashboard/` が存在しない場合は作成

**チェックポイント**: テストディレクトリがテストファイル用に準備完了

---

## フェーズ 2: 基盤 (ブロッキングする前提条件なし)

**目的**: このバグ修正には基盤インフラ要件がありません。すべての依存関係（React、dayjs、Material-UI、Vitest）はプロジェクトですでに設定されています。

**注記**: フェーズ2は空です。これは既存コードのバグ修正だからです。ユーザーストーリーの実装に直接進みます。

---

## フェーズ 3: ユーザーストーリー 1 - 最新のワークアウトを最初に表示 (優先度: P1) 🎯 MVP

**ゴール**: 日付グループの順序を修正し、最新のワークアウト日付がアコーディオンの最初に表示されるようにします。ユーザーはスクロールせずに最上部で最新のワークアウトアクティビティを確認できるべきです。

**独立テスト**: 異なる日付（例：10月5日、8日、11日）に3つ以上のワークアウトを作成し、最近のワークアウトアコーディオンを開いて、日付が降順（10月11日 → 10月8日 → 10月5日）で表示されることを確認します。

**受入基準** (spec.mdより):
1. 日付が表示される順序：最新が最初、最古が最後
2. `createdAt`によって最新の10件のワークアウトが選択される
3. 今日のワークアウトがリストの最上部に表示される

### ユーザーストーリー 1 のテスト

**注記: TDDを使用してこれらのテストを最初に書く - 実装前に失敗することを確認**

- [ ] T003 [P] [US1] `frontend/tests/unit/workoutGrouping.test.js` でグループ化前の `createdAt` によるワークアウトのソートの単体テストを書く（テスト: 異なる createdAt タイムスタンプを持つ15件の未ソートワークアウトが与えられたとき、groupByDate が createdAt による最新10件のみを返すことを確認）
- [ ] T004 [P] [US1] `frontend/tests/unit/workoutGrouping.test.js` で10件制限の単体テストを書く（テスト: 20件のワークアウトが与えられたとき、正確に10件が返されることを確認）
- [ ] T005 [P] [US1] `frontend/tests/unit/workoutGrouping.test.js` で空入力の単体テストを書く（テスト: 空配列が与えられたとき、空オブジェクトを返す）
- [ ] T006 [P] [US1] `frontend/tests/unit/workoutGrouping.test.js` で単一ワークアウトの単体テストを書く（テスト: 1件のワークアウトが与えられたとき、1アイテムを持つ単一日付グループを返す）
- [ ] T007 [US1] `groupByDate` 関数の単体テストを実行し、失敗することを確認（想定内、実装はまだ）
- [ ] T008 [P] [US1] `frontend/src/test/components/Dashboard/RecentWorkoutsAccordion.test.jsx` で日付の視覚的順序のコンポーネントテストを書く（テスト: 10月5日、8日、11日のワークアウトが与えられたとき、DOM要素が10月11日 → 10月8日 → 10月5日と表示されることを確認）
- [ ] T009 [P] [US1] `frontend/src/test/components/Dashboard/RecentWorkoutsAccordion.test.jsx` で空状態のコンポーネントテストを書く（テスト: ワークアウトがないとき、「まだワークアウト記録がありません」メッセージを確認）
- [ ] T010 [US1] コンポーネントテストを実行し、失敗することを確認（想定内、実装はまだ）

### ユーザーストーリー 1 の実装

- [ ] T011 [US1] `frontend/src/services/workoutGrouping.js:8` の `groupByDate` 関数で `createdAt` によるソートを実装（追加: `const sortedWorkouts = [...workouts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 10);` を追加し、forEach で sortedWorkouts を使用）
- [ ] T012 [US1] `groupByDate` の単体テストを実行し、合格することを確認
- [ ] T013 [US1] `frontend/src/components/Dashboard/RecentWorkoutsAccordion.jsx:46` のコンポーネントで日付グループソートを実装（追加: Object.entries() と .map() の間に `.sort((a, b) => new Date(b[0]) - new Date(a[0]))` を追加）
- [ ] T014 [US1] コンポーネントテストを実行し、合格することを確認
- [ ] T015 [US1] 実データでの手動テスト: 10月5日、8日、11日に3件のワークアウトを作成し、アコーディオンで10月11日が最初に表示されることを確認

**チェックポイント**: ユーザーストーリー 1 完了 - 日付が降順で表示され、最新の10件のワークアウトが正しく選択される

---

## フェーズ 4: ユーザーストーリー 2 - 同日の複数ワークアウトを時系列順に表示 (優先度: P2)

**ゴール**: 同じ日付グループ内のワークアウトが逆時系列順（最新の時刻が最初）で表示されることを保証します。1日に複数のワークアウトを行うユーザーはセッションの順序を追跡できます。

**独立テスト**: 同じ日付に異なる時刻（09:00、14:30、18:00）で3件のワークアウトを作成し、アコーディオンを開いて、タイムスタンプが降順（18:00 → 14:30 → 09:00）で表示されることを確認します。

**受入基準** (spec.mdより):
1. 同日のワークアウトが時刻順（最新が最初）で並んでいる
2. タイムスタンプ [HH:mm] が各日付グループ内で上から下へ減少する

**注記**: ユーザーストーリー 2 は、ユーザーストーリー 1 の実装によって大部分が完了しています。`groupByDate` での `createdAt` によるソートは、すでにグループ内の時系列順を保証しています。このフェーズは検証とエッジケーステストに焦点を当てます。

### ユーザーストーリー 2 のテスト

- [ ] T016 [P] [US2] `frontend/tests/unit/workoutGrouping.test.js` でグループ内順序の単体テストを書く（テスト: 同じ日付に異なる時刻で3件のワークアウトが与えられたとき、日付グループ内で createdAt の降順で表示されることを確認）
- [ ] T017 [US2] 単体テストを実行し、合格することを確認（US1実装により合格するはず）
- [ ] T018 [P] [US2] `frontend/src/test/components/Dashboard/RecentWorkoutsAccordion.test.jsx` でタイムスタンプ表示と順序のコンポーネントテストを書く（テスト: 10月11日に09:00、14:30、18:00で3件のワークアウトが与えられたとき、[18:00]、[14:30]、[09:00]がその順序で表示されることを確認）
- [ ] T019 [US2] コンポーネントテストを実行し、合格することを確認（既存の hasMultipleWorkoutsOnSameDay ロジックにより合格するはず）

### ユーザーストーリー 2 の実装

- [ ] T020 [US2] グループ内ソートが正しく動作することを確認（コード変更は不要、groupByDate の sortedWorkouts を検査して確認）
- [ ] T021 [US2] 実データでの手動テスト: 同じ日付に09:00、14:30、18:00で3件のワークアウトを作成し、[18:00]が正しい時刻順で最初に表示されることを確認

**チェックポイント**: ユーザーストーリー 2 完了 - 同日のワークアウトが正しいタイムスタンプで逆時系列順に表示される

---

## フェーズ 5: 仕上げ & 横断的関心事

**目的**: 両方のユーザーストーリーにわたる最終検証とエッジケーステスト

- [ ] T022 [P] [US1+US2] エッジケーステスト: すべての10件のワークアウトが同じ日（時刻順の10件のワークアウトを持つ単一の日付グループを確認）
- [ ] T023 [P] [US1+US2] エッジケーステスト: 同一のタイムスタンプ（安定ソート、クラッシュなしを確認）
- [ ] T024 [P] [US1+US2] エッジケーステスト: 11件以上のワークアウト（最新10件のみ表示されることを確認）
- [ ] T025 [US1+US2] useMemo最適化が保持されていることを確認（groupByDateが無関係なDashboard再レンダリング時に再実行されないことを確認）
- [ ] T026 [US1+US2] カバレッジ付きで完全なテストスイートを実行: `cd frontend && npm run test:coverage`（workoutGrouping.jsで80%以上のカバレッジを確認）
- [ ] T027 [US1+US2] パフォーマンスチェック: ダッシュボードレンダリングが<150msに留まることを確認（React DevTools Profilerを使用）
- [ ] T028 [US1+US2] `specs/002-recentworkoutsaccordin/quickstart.md` の quickstart.md 手動テストチェックリストに従う
- [ ] T029 [US1+US2] コードレビュー自己チェック: コンポーネントプロップやAPIへの破壊的変更がないことを確認
- [ ] T030 [US1+US2] Gitコミット、メッセージ: "fix(frontend): sort recent workouts in descending chronological order (#002)"

**チェックポイント**: バグ修正完了、テスト済み、PR準備完了

---

## 依存関係 & 実行順序

### フェーズ依存関係

- **セットアップ (フェーズ 1)**: 依存関係なし - すぐに開始可能
- **基盤 (フェーズ 2)**: 空（ブロッキングする前提条件なし）
- **ユーザーストーリー 1 (フェーズ 3)**: セットアップ完了に依存
- **ユーザーストーリー 2 (フェーズ 4)**: ユーザーストーリー 1 完了に依存（ソートロジックを継承）
- **仕上げ (フェーズ 5)**: 両方のユーザーストーリーの完了に依存

### ユーザーストーリー依存関係

- **ユーザーストーリー 1 (P1)**: セットアップ (フェーズ 1) 後に開始可能 - 他のストーリーへの依存関係なし
- **ユーザーストーリー 2 (P2)**: ユーザーストーリー 1 実装に依存（ソートロジックを共有）

**注記**: 典型的なマルチストーリー機能とは異なり、US2はUS1で実装されたソートロジックに依存するため、完全には独立していません。ただし、同日ワークアウト順序に対する独立したテストカバレッジを追加します。

### 各ユーザーストーリー内

**ユーザーストーリー 1**:
1. すべての単体テストを並列で書く（T003-T006は一緒に実行可能）
2. 単体テストを実行して失敗を確認（T007）
3. すべてのコンポーネントテストを並列で書く（T008-T009は一緒に実行可能）
4. コンポーネントテストを実行して失敗を確認（T010）
5. `groupByDate` ソートを実装（T011）
6. 単体テストの合格を確認（T012）
7. コンポーネント日付ソートを実装（T013）
8. コンポーネントテストの合格を確認（T014）
9. 手動検証（T015）

### 並列実行の機会

**フェーズ 1 - セットアップ**:
```bash
# 両方のテストディレクトリを並列で作成可能
タスク T001: frontend/tests/unit/ を作成
タスク T002: frontend/src/test/components/Dashboard/ を作成
```

**フェーズ 3 - US1 単体テスト**:
```bash
# すべての単体テストケースを並列で書ける（異なるテストケース）
タスク T003: createdAtによるソートのテスト
タスク T004: 10件制限のテスト
タスク T005: 空入力のテスト
タスク T006: 単一ワークアウトのテスト
```

---

## 実装戦略

### MVP優先 (ユーザーストーリー 1 のみ)

1. フェーズ 1 完了: セットアップ（テストディレクトリ）
2. フェーズ 3 完了: ユーザーストーリー 1
   - テストを書く（T003-T010）
   - ソートを実装（T011-T014）
   - 手動検証（T015）
3. **停止して検証**: ユーザーストーリー 1 を独立してテスト
4. 準備ができていればデプロイ/デモ

**MVP成果物**: 日付が降順で表示され、最新10件のワークアウトが正しく表示される

### フル機能 (両方のユーザーストーリー)

1. MVP完了（ユーザーストーリー 1）
2. ユーザーストーリー 2 追加:
   - 検証テストを書く（T016-T019）
   - グループ内順序を確認（T020-T021）
3. 仕上げフェーズ完了:
   - エッジケーステスト（T022-T024）
   - パフォーマンス検証（T025-T027）
   - 最終チェック（T028-T030）
4. コードレビューのためのPR作成

**フル機能成果物**: 日付レベルと時刻レベルの両方のソートが包括的なテストカバレッジで正しく動作

---

## タスク概要

**合計タスク**: 30
- フェーズ 1 (セットアップ): 2タスク
- フェーズ 2 (基盤): 0タスク（前提条件なし）
- フェーズ 3 (ユーザーストーリー 1): 13タスク（8テスト + 5実装）
- フェーズ 4 (ユーザーストーリー 2): 6タスク（4テスト + 2検証）
- フェーズ 5 (仕上げ): 9タスク（エッジケース + 検証）

**ユーザーストーリー別タスク**:
- ユーザーストーリー 1 (P1): 13タスク（クリティカルパス）
- ユーザーストーリー 2 (P2): 6タスク（増分）
- 共有/仕上げ: 11タスク（セットアップ + 仕上げ）

**並列実行の機会**: 12タスクが並列実行可能（[P]マーク付き）

**推定時間** (quickstart.mdより):
- セットアップ: 2分
- US1実装: 10分（ファイルごとに5分）
- US1テスト: 15分（単体テスト）
- US2検証: 10分（テストのみ）
- 仕上げ: 15分（エッジケース + 検証）
- **合計**: 52分（約1時間）

---

## 注記

- [P]タスク = 異なるファイル/テストケース、互いに依存関係なし
- [Story]ラベルは特定のユーザーストーリー（US1, US2）にタスクをマッピングしてトレーサビリティを確保
- US2は共有ソートロジックのため完全には独立していないが、独立したテストカバレッジを追加
- TDDに従う: 最初にテストを書き、失敗を見て、実装し、合格を見る
- 実装前にテストが失敗することを確認（テストが実際にバグをテストしていることを確認）
- 各チェックポイントでストーリーを独立して検証可能
- 各フェーズまたはタスクの論理的グループの後にコミット
- すべてのファイルパスはリポジトリルートからの絶対パス
- バックエンド、API、またはデータベースの変更は不要
- コンポーネントプロップやAPI契約への破壊的変更なし
