# 機能仕様書: ワークアウトフォームリセットバグ修正

**Feature Branch**: `003-reset-ui-react`
**作成日**: 2025-10-20
**ステータス**: Draft
**Input**: ユーザー説明: "ワークアウトフォーム送信後のリセット処理が正しく動作しない問題を修正する。現在の問題: フォーム送信成功後、入力値がクリアされずに残る、reset()は呼ばれているがUIに反映されない、設定変更時のリセットも不安定。期待される動作: 送信成功後、すべての入力値が即座にクリアされる、設定変更時も確実にリセットされる、React Hook Formのreset()とUIが正しく同期する"

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー 1 - ワークアウト送信後のフォームリセット成功 (優先度: P1)

ユーザーがワークアウトセッションを完了してデータを送信する。送信成功後、フォームはすべての入力値を即座にクリアし、手動でクリアすることなく次のワークアウトのための新しい状態になる必要がある。

**この優先度の理由**: これは毎日のユーザー体験に影響を与える中核的な問題です。ユーザーが1日に複数回ワークアウトを送信する際、前の値が表示されたままだと混乱を招き、重複送信のリスクがあります。これは主要なワークフローを妨げます。

**独立したテスト**: ワークアウトデータ（例：腕立て伏せ15回）を入力し、送信ボタンをクリックし、成功メッセージを確認した後、すべての入力フィールドが空になっていることを確認することで完全にテストできます。データ入力エラーを防ぐ即座の価値を提供します。

**受け入れシナリオ**:

1. **前提** ユーザーがワークアウトデータ（例：懸垂のセット1に10回、セット2に8回）を入力している、**操作** フォームを正常に送信する、**結果** すべてのエクササイズ入力フィールド（すべてのセット）が即座に空/デフォルト値を表示する
2. **前提** ユーザーが有酸素運動データ（例：距離5km、時間30分）を入力している、**操作** フォームを正常に送信する、**結果** 距離と時間のフィールドが即座に空の値を表示する
3. **前提** ユーザーが「高」の強度を選択して送信した、**操作** 送信が成功する、**結果** 強度セレクターがデフォルトの空状態にリセットされる
4. **前提** ユーザーが複数のエクササイズにデータを入力している、**操作** 送信が成功する、**結果** 表示されているすべてのエクササイズカードの入力が同時にリセットされる

---

### ユーザーストーリー 2 - 設定変更後の信頼性のあるフォームリセット (優先度: P2)

ユーザーがワークアウト設定を変更する（例：エクササイズの変更、最大セット数の調整）。設定変更を保存した後、フォームは確実にリセットされ、前の設定からの古いデータを表示せずに新しい構造を反映する必要がある。

**この優先度の理由**: 設定変更は日々の送信ほど頻繁ではありませんが、発生した場合、古いデータは深刻な混乱を引き起こします。ユーザーは新しい設定に一致する新鮮なフォームを期待します。

**独立したテスト**: 設定ドロワーを開き、最大セット数を3から5に変更し、設定を保存し、すべての入力フィールドがリセットされ、フォーム構造が正しく更新されることを確認することで独立してテストできます。設定変更が安全で予測可能であることを保証する価値を提供します。

**受け入れシナリオ**:

1. **前提** ユーザーがデータが入力されたフォームを持っている、**操作** 最大セット数を3から5に変更して保存する、**結果** すべての入力フィールドがリセットされ、5つのセット入力が表示される
2. **前提** ユーザーがエクササイズAにデータを入力している、**操作** 設定でエクササイズAをエクササイズBに変更して保存する、**結果** フォームにエクササイズBの入力が空/デフォルト値で表示される
3. **前提** ユーザーが筋トレのエクササイズデータを入力している、**操作** そのエクササイズを有酸素運動タイプに変更して保存する、**結果** フォームにセット入力の代わりに空の有酸素運動入力フィールド（距離/時間）が表示される

---

### ユーザーストーリー 3 - 複数回の送信サイクルにわたる一貫したフォーム動作 (優先度: P3)

ユーザーが分割ワークアウトセッション中に連続して複数回ワークアウトを送信する（例：同じ日の午前と夕方のワークアウト）。各送信サイクルは、フォームが何回使用されたかに関係なく、一貫したリセット動作を維持する必要がある。

**この優先度の理由**: 1日に複数回ワークアウトを記録するパワーユーザーには、信頼性のある動作が必要です。これにより、繰り返し使用後の劣化を防ぎ、アプリケーションに対するユーザーの信頼を構築します。

**独立したテスト**: 3〜5回のワークアウトを連続して送信し、各送信で完全なフォームリセットが行われることを確認することでテストできます。1日に複数回トレーニングするユーザーに価値を提供します。

**受け入れシナリオ**:

1. **前提** ユーザーがその日の最初のワークアウトを送信した、**操作** 4時間後に2回目のワークアウトを送信する、**結果** フォームは最初の送信と同じくらい確実にリセットされる
2. **前提** ユーザーが1つのセッションで3回のワークアウトを送信した、**操作** 4回目のワークアウトを送信する、**結果** リセット動作は蓄積された状態の問題なく一貫している
3. **前提** ユーザーが最初の送信で成功したリセットを経験した、**操作** 設定を変更して再度送信する、**結果** リセットは確実に機能し続ける

---

### エッジケース

- フォーム送信が失敗した場合（ネットワークエラー、バリデーションエラー）はどうなるか？ **期待**: フォーム値は再入力なしで再試行できるよう、そのまま保持される
- ユーザーが最初の送信からの成功メッセージが消える前に2回目のワークアウトのデータ入力を開始した場合はどうなるか？ **期待**: フォームは最初の送信後すぐにリセットされ、偶発的なデータの混在を防ぐ
- 送信中に設定変更が発生した場合はどうなるか？ **期待**: 設定変更は現在の送信が完了するまでキューに入れられるかブロックされる
- ユーザーが送信ボタンを急速に複数回クリックした場合はどうなるか？ **期待**: 重複送信は防止され、リセットはすべてのリクエストが正常に完了した後にのみ発生する
- localStorageが破損しているか利用できない場合はどうなるか？ **期待**: フォームはメモリ内のデフォルトを使用してリセットされるが、設定の永続化は失敗する可能性がある

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、ワークアウト送信成功後、すべてのエクササイズ入力フィールド（セット、回数、距離、時間）を即座にクリアしなければならない
- **FR-002**: システムは、送信成功後、強度セレクターをデフォルト状態にリセットしなければならない
- **FR-003**: システムは、リセット操作中にフォームの内部状態と表示されているUI要素を同期しなければならない
- **FR-004**: システムは、ユーザーが設定変更（エクササイズ選択、最大セット数調整）を保存したときにフォームをリセットしなければならない
- **FR-005**: システムは、送信が失敗した場合、ユーザーが再入力せずに再試行できるようユーザー入力を保持しなければならない
- **FR-006**: システムは、セッション中にフォームが何回送信されたかに関係なく、リセット操作を一貫して処理しなければならない
- **FR-007**: システムは、動的に生成されたすべての入力フィールド（maxSets設定に基づく可変セット数）をリセットしなければならない
- **FR-008**: システムは、成功フィードバックメッセージが非表示になる前にリセット操作を完了しなければならない
- **FR-009**: システムは、前の送信のリセット操作が進行中の間、ユーザーが新しいデータを送信することを防止しなければならない

### 主要エンティティ

- **ワークアウト送信**: エクササイズデータ（筋トレ：セット/回数、有酸素運動：距離/時間）と全体的な強度を含む完了したワークアウトセッションを表す
- **フォーム設定**: ワークアウトフォームの構造（どのエクササイズがアクティブか、許可される最大セット数）を定義する
- **フォーム状態**: エクササイズ固有のデータとグローバルな強度設定を含む、すべての入力フィールドにわたってユーザーが入力した現在の値

## 成功基準 *(必須)*

### 測定可能な結果

- **SC-001**: ユーザーは、ワークアウトを送信し、成功メッセージが表示されてから500ミリ秒以内にすべての入力フィールドがクリアされるのを確認できる
- **SC-002**: フォームリセットの成功率は、すべての送信シナリオ（最初の送信、繰り返し送信、設定変更後）で100%に達する
- **SC-003**: 送信成功後に古いフォーム値が表示されたままになることによる重複ワークアウト送信がゼロになる
- **SC-004**: 設定変更は100%の確率で正しいフォームリセットを実行し、前の設定からの古いデータがない
- **SC-005**: ユーザーは、入力フィールドを手動でクリアする必要なく、連続したワークアウト送信を完了する
- **SC-006**: フォーム状態とUIは、劣化なしに10回以上の連続送信サイクルにわたって同期を保つ

## 前提条件 *(必須)*

- 現在のフォームライブラリ（React Hook Form）が引き続き使用される；大きなライブラリ変更は計画されていない
- ユーザーは主にJavaScriptが有効な最新のWebブラウザ（Chrome、Firefox、Safari、Edge）を通じてアプリケーションにアクセスする
- 成功フィードバックメッセージの表示時間（コードレビューに基づくと3秒）は、ユーザーが確認を見るのに十分である
- ワークアウト送信API呼び出しのネットワーク遅延は通常2秒未満である
- ユーザーは遅延したリセット操作ではなく、即座の視覚的フィードバック（フォームのクリア）を期待する
- LocalStorageは設定の永続化のために利用可能で機能的である
- 現在の設定管理システム（workoutConfig）がフォーム構造の単一の真実の源であり続ける

## スコープ外 *(必須)*

- ワークアウト送信APIエンドポイントまたはバックエンドバリデーションロジックの変更
- 信頼性のあるリセット動作に必要な範囲を超える設定ドロワーUI/UXの変更
- 送信されたワークアウトのアンドゥ/リドゥ機能の実装
- フォームレンダリングパフォーマンスの最適化（焦点はリセットの信頼性のみ）
- バリデーションルールまたはエラーメッセージ内容の変更
- 別のフォーム管理ライブラリへの移行
- 新しい入力フィールドタイプまたはエクササイズカテゴリの追加
- 部分的に完了したワークアウトの自動保存またはドラフト機能

## 依存関係と制約 *(必須)*

### 依存関係

- React Hook Formライブラリの`reset()`関数が現在のフォーム構造で正しく動作する必要がある
- `generateDefaultValues()`ユーティリティ関数がすべての可能な設定状態に対して正しいデフォルト値を生成する必要がある
- リセット操作が成功したと見なされる前に、成功フィードバックメカニズムが完了する必要がある
- `FormConfigDrawer`を通じて保存された設定変更がフォーム構造の更新をトリガーする必要がある

### 制約

- 既存のlocalStorageデータ形式との後方互換性を維持する必要がある
- `useWorkoutSubmit`、`useFormConfig`、または`useFormValidation`フックのインターフェースに破壊的変更を導入できない
- 現在のフォームバリデーション動作（バリデーションがトリガーされるタイミング、表示されるエラー）を保持する必要がある
- リセット操作は、空のフィールドにエラーメッセージを表示するフォーム再バリデーションを引き起こしてはならない
- ソリューションは、ユーザーがページを更新したりブラウザキャッシュをクリアしたりする必要なく機能する必要がある
